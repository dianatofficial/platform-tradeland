<app-query-state [status]="status()" [error]="error()">
  <div slot="loading">
    <div class="flex justify-center items-center h-96">
        <svg class="animate-spin h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>
  </div>

  <div slot="error">
    <div class="text-center py-20">
      <div class="ios-card max-w-lg mx-auto p-8">
        <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto"></i>
        <h3 class="mt-4 text-xl font-bold text-gray-800">خطا در بارگذاری</h3>
        <p class="mt-2 text-gray-600">{{ error() }}</p>
        <a routerLink="/courses" class="ios-button ios-button-primary mt-6">بازگشت به لیست دوره ها</a>
      </div>
    </div>
  </div>
  
  @if (course(); as course) {
  <div class="bg-gray-50">
    <!-- HERO SECTION -->
    <div class="bg-slate-900 text-white">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
        <div class="grid lg:grid-cols-3 gap-8 items-center">
          <div class="lg:col-span-2">
            <app-breadcrumb [items]="breadcrumbs()" theme="dark"></app-breadcrumb>
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight">{{ course.title }}</h1>
            <p class="mt-3 text-lg text-gray-300 max-w-3xl">{{ plainDescription() }}</p>
            <div class="mt-4 flex items-center gap-x-6 gap-y-2 flex-wrap text-sm">
              <div class="flex items-center gap-2">
                <img [src]="course.instructorImage" [alt]="course.instructor" class="w-8 h-8 rounded-full">
                <span>مدرس: <a [routerLink]="[]" class="font-semibold hover:underline">{{ course.instructor }}</a></span>
              </div>
              <div class="flex items-center gap-2 text-amber-400">
                <span class="font-bold">{{ course.rating }}</span>
                <div class="flex">
                  @for(i of getStars(course.rating ?? 0); track $index) { <i data-lucide="star" class="w-4 h-4 lucide-filled"></i> }
                </div>
                <a href="#reviews" class="text-gray-300 hover:underline">({{ course.reviewCount }} نظر)</a>
              </div>
            </div>
            <div class="flex items-center gap-x-6 gap-y-2 mt-4 text-sm text-gray-400 flex-wrap">
              <div class="flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> آخرین بروزرسانی: {{ course.lastUpdate }}</div>
              <div class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> {{ course.students }} دانشجو</div>
              <div class="flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> {{ course.duration }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT & SIDEBAR -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="lg:grid lg:grid-cols-12 lg:gap-12">
        <!-- Main Content (Left) -->
        <main class="lg:col-span-8">
          
          <!-- Mobile Purchase Card -->
           <div class="lg:hidden ios-card overflow-hidden mb-8 shadow-xl">
             <a [routerLink]="['/courses', course.id, 'watch', course.syllabus[0].lessons[0].id]" class="block relative group">
                  <img [src]="course.imageUrl" alt="{{ course.title }}" class="w-full h-auto aspect-video object-cover">
                  <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <span class="text-white bg-black/50 rounded-full p-4"><i data-lucide="play" class="w-12 h-12 lucide-filled"></i></span>
                  </div>
              </a>
              <div class="p-6">
                @if(course.subscriptionOnly) {
                  <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg text-center">
                    <div class="flex items-center justify-center gap-2"><span class="text-purple-600"><i data-lucide="crown" class="w-5 h-5"></i></span><p class="font-semibold text-purple-800">این دوره در اشتراک ویژه موجود است</p></div>
                    <a routerLink="/subscriptions" class="mt-3 inline-block ios-button bg-purple-600 text-white hover:bg-purple-700 w-full text-center">مشاهده پلن های اشتراک</a>
                  </div>
                } @else {
                  <div class="flex items-baseline gap-2"><span class="text-3xl font-extrabold text-gray-900">{{ course.price }}</span><span class="text-lg font-medium text-gray-700">تومان</span></div>
                  <div class="mt-4 flex flex-col gap-3">
                    <button class="ios-button ios-button-primary w-full text-md">ثبت نام در دوره</button>
                    <button class="ios-button bg-gray-200 text-gray-800 hover:bg-gray-300 w-full text-md">افزودن به سبد خرید</button>
                  </div>
                }
              </div>
          </div>

          <!-- What you'll learn -->
          <div class="ios-card p-6 border border-gray-200">
            <h2 class="text-2xl font-bold mb-4">چه چیزهایی یاد می‌گیرید؟</h2>
            <ul class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-3">
                @for(item of course.whatYouWillLearn; track item) {
                <li class="flex items-start gap-3">
                    <span class="text-green-500 mt-1 flex-shrink-0"><i data-lucide="check-circle" class="w-5 h-5"></i></span>
                    <span class="text-gray-700">{{ item }}</span>
                </li>
                }
            </ul>
          </div>

          <!-- Syllabus -->
          <div class="mt-10">
            <h2 class="text-2xl font-bold mb-4">سرفصل های دوره</h2>
            <div class="space-y-2">
                @for(section of course.syllabus; track section.sectionTitle; let i = $index) {
                    <div class="ios-card overflow-hidden">
                        <button (click)="toggleSection(i)" class="w-full flex items-center justify-between p-4 text-right bg-white hover:bg-gray-50">
                            <span class="font-bold text-gray-800">{{ section.sectionTitle }}</span>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-500 transition-transform" [class.rotate-180]="openSectionIndex() === i"></i>
                        </button>
                        @if(openSectionIndex() === i) {
                          <div class="bg-white">
                              <ul class="divide-y divide-gray-100">
                                  @for(lesson of section.lessons; track lesson.id) {
                                  <li class="hover:bg-gray-50">
                                      <a [routerLink]="['/courses', course.id, 'watch', lesson.id]" class="flex justify-between items-center p-4">
                                          <div class="flex items-center gap-3 text-gray-700">
                                              @if(lesson.isFreePreview) {
                                                  <i data-lucide="play-circle" class="w-5 h-5 text-blue-500"></i>
                                              } @else {
                                                  <i data-lucide="lock" class="w-5 h-5 text-gray-400"></i>
                                              }
                                              <span class="font-medium text-sm">{{ lesson.title }}</span>
                                          </div>
                                          <div class="flex items-center gap-4">
                                              @if(lesson.isFreePreview) {
                                                <span class="text-xs font-semibold text-blue-600">پیش نمایش</span>
                                              }
                                              <span class="text-sm text-gray-500">{{ lesson.duration }}</span>
                                          </div>
                                      </a>
                                  </li>
                                  }
                              </ul>
                          </div>
                        }
                    </div>
                }
            </div>
          </div>

          <!-- Description and Requirements (merged) -->
          <div class="mt-10 ios-card p-6">
            <h2 class="text-2xl font-bold mb-4">توضیحات کامل دوره</h2>
            <div class="prose prose-lg max-w-none" [innerHTML]="course.description"></div>
            
            <h3 class="text-xl font-bold mt-8 mb-4">پیش نیازها</h3>
            <ul class="space-y-3">
              @for(req of course.requirements; track req) {
                <li class="flex items-start gap-3">
                  <span class="text-gray-500 mt-1 flex-shrink-0"><i data-lucide="info" class="w-5 h-5"></i></span>
                  <span class="text-gray-700">{{ req }}</span>
                </li>
              }
            </ul>
          </div>
          
          <!-- Instructor -->
          <div class="mt-10 ios-card p-6">
            <h2 class="text-2xl font-bold mb-4">معرفی مدرس</h2>
            <div class="flex flex-col sm:flex-row items-center gap-6">
              <img class="w-24 h-24 rounded-full object-cover" [src]="course.instructorImage" alt="">
              <div>
                  <h3 class="text-xl font-bold text-blue-600">{{ course.instructor }}</h3>
                  <p class="mt-2 text-gray-600 leading-relaxed">{{ course.instructorBio }}</p>
              </div>
            </div>
          </div>
          
          <!-- Reviews -->
          <div id="reviews" class="mt-10 ios-card p-6">
            <h2 class="text-2xl font-bold mb-4">نظرات دانشجویان</h2>
            <div class="space-y-6">
                @for(review of course.reviews; track review.name) {
                    <div class="flex items-start gap-4 border-b border-gray-100 pb-4 last:border-0 last:pb-0">
                        <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600 flex-shrink-0">
                            {{ review.name.charAt(0) }}
                        </div>
                        <div>
                            <h4 class="font-bold">{{ review.name }}</h4>
                            <div class="flex items-center my-1 text-amber-400">
                                @for(i of getStars(review.rating); track $index) { <i data-lucide="star" class="w-5 h-5 lucide-filled"></i> }
                            </div>
                            <p class="text-gray-700 text-sm">{{ review.comment }}</p>
                        </div>
                    </div>
                }
            </div>
          </div>
        </main>

        <!-- Desktop Sidebar (Right) -->
        <aside class="hidden lg:block lg:col-span-4">
          <div class="ios-card overflow-hidden sticky top-24 shadow-xl">
              <a [routerLink]="['/courses', course.id, 'watch', course.syllabus[0].lessons[0].id]" class="block relative group">
                  <img [src]="course.imageUrl" alt="{{ course.title }}" class="w-full h-auto aspect-video object-cover">
                  <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <span class="text-white bg-black/50 rounded-full p-4"><i data-lucide="play" class="w-12 h-12 lucide-filled"></i></span>
                  </div>
              </a>
              <div class="p-6">
                @if(course.subscriptionOnly) {
                  <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg text-center">
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-purple-600"><i data-lucide="crown" class="w-5 h-5"></i></span>
                        <p class="font-semibold text-purple-800">این دوره در اشتراک ویژه موجود است</p>
                    </div>
                    <a routerLink="/subscriptions" class="mt-3 inline-block ios-button bg-purple-600 text-white hover:bg-purple-700 w-full text-center">
                        مشاهده پلن های اشتراک
                    </a>
                  </div>
                } @else {
                  <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-extrabold text-gray-900">{{ course.price }}</span>
                    <span class="text-lg font-medium text-gray-700">تومان</span>
                  </div>
                  <div class="mt-4 flex flex-col gap-3">
                    <button class="ios-button ios-button-primary w-full text-md">ثبت نام در دوره</button>
                    <button class="ios-button bg-gray-200 text-gray-800 hover:bg-gray-300 w-full text-md">افزودن به سبد خرید</button>
                  </div>
                }
                <div class="mt-6 text-sm">
                  <h4 class="font-bold mb-3">این دوره شامل:</h4>
                  <ul class="space-y-3 text-gray-600">
                    <li class="flex items-center gap-2"><i data-lucide="video" class="w-5 h-5 text-gray-500"></i> {{ course.duration }} محتوای ویدیویی</li>
                    <li class="flex items-center gap-2"><i data-lucide="infinity" class="w-5 h-5 text-gray-500"></i> دسترسی مادام العمر</li>
                    <li class="flex items-center gap-2"><i data-lucide="award" class="w-5 h-5 text-gray-500"></i> گواهی پایان دوره</li>
                    <li class="flex items-center gap-2"><i data-lucide="smartphone" class="w-5 h-5 text-gray-500"></i> دسترسی در تمام دستگاه‌ها</li>
                  </ul>
                </div>
              </div>
          </div>
        </aside>
      </div>
    </div>
  </div>
  } @else {
      <div class="text-center py-20">
          <p>دوره مورد نظر یافت نشد.</p>
          <a routerLink="/courses" class="ios-button ios-button-primary mt-4">بازگشت به لیست دوره ها</a>
      </div>
  }
</app-query-state>